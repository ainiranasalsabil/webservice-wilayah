<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login | Web Service Wilayah</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #1b5e20 0%, #1565c0 100%);
      display: flex; align-items: center; justify-content: center;
      font-family: 'Segoe UI', sans-serif;
    }
    .login-card {
      width: 100%; max-width: 420px; border: none; border-radius: 20px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.3); overflow: hidden; background: white;
    }
    .login-header {
      background: linear-gradient(90deg, #2e7d32, #1e88e5);
      padding: 30px; color: white; text-align: center;
    }
    .btn-primary { background: #1565c0; border: none; border-radius: 10px; padding: 12px; }
    .api-key-box {
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        font-family: monospace;
        letter-spacing: 1px;
    }
  </style>
</head>
<body>

<div class="card login-card">
  <div class="login-header">
    <i class="bi bi-geo-alt-fill" style="font-size: 3rem;"></i>
    <h4 class="mt-2 mb-0">Portal Wilayah</h4>
  </div>
  <div class="card-body p-4">
    <div class="mb-3">
      <label class="form-label small fw-bold">Email</label>
      <input id="email" type="email" class="form-control" placeholder="nama@email.com">
    </div>
    <div class="mb-3">
      <label class="form-label small fw-bold">Password</label>
      <input id="password" type="password" class="form-control" placeholder="••••••••">
    </div>
    <div class="mb-4">
      <div class="d-flex justify-content-between">
        <label class="form-label small fw-bold text-primary">API Key</label>
        <a href="javascript:void(0)" onclick="revealApiKey()" class="small text-decoration-none text-danger fw-bold">Lupa API Key?</a>
      </div>
      <input id="apiKey" class="form-control" placeholder="Masukkan API Key anda">
    </div>
    <button class="btn btn-primary w-100 mb-3" onclick="login()">Masuk</button>
    <div class="text-center small">
      Belum punya akun? <a href="register.html" class="fw-bold text-decoration-none">Daftar</a>
    </div>
  </div>
</div>

<div class="modal fade" id="revealModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 20px;">
      <div class="modal-body text-center p-4">
        <i class="bi bi-key-fill text-warning" style="font-size: 3rem;"></i>
        <h5 class="fw-bold mt-3">API Key Anda Ditemukan!</h5>
        <p class="text-muted small">Silakan salin kode di bawah ini untuk login:</p>
        
        <div class="api-key-box p-3 rounded mb-3 position-relative">
            <code id="revealedKey" class="text-dark fw-bold" style="word-break: break-all; font-size: 1.1rem;"></code>
        </div>

        <button class="btn btn-outline-primary btn-sm mb-3" onclick="copyToClipboard()">
            <i class="bi bi-clipboard"></i> Copy API Key
        </button>

        <button type="button" class="btn btn-dark w-100 rounded-pill" data-bs-dismiss="modal">Tutup</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
async function revealApiKey() {
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;

  if (!email || !password) {
      alert('Isi email dan password dulu untuk melihat API Key');
      return;
  }

  try {
    const res = await fetch('/api/auth/reveal-api-key', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });

    const data = await res.json();
    if (res.ok) {
      document.getElementById('revealedKey').innerText = data.apiKey;
      // Munculkan Modal
      const myModal = new bootstrap.Modal(document.getElementById('revealModal'));
      myModal.show();
    } else {
      alert(data.message);
    }
  } catch (err) {
    alert('Terjadi kesalahan koneksi');
  }
}

function copyToClipboard() {
    const keyText = document.getElementById('revealedKey').innerText;
    navigator.clipboard.writeText(keyText).then(() => {
        alert('API Key berhasil disalin ke clipboard!');
        document.getElementById('apiKey').value = keyText;
    });
}

async function login() {
  const emailVal = document.getElementById('email').value;
  const passwordVal = document.getElementById('password').value;
  const apiKeyVal = document.getElementById('apiKey').value;

  // Validasi dasar di frontend (Email & Pass wajib untuk siapapun)
  if (!emailVal || !passwordVal) {
    alert('Email dan Password wajib diisi!');
    return;
  }

  const payload = {
    email: emailVal,
    password: passwordVal,
    apiKey: apiKeyVal // Boleh kosong jika dia admin
  };

  try {
    const res = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    
    if (res.ok) {
      localStorage.setItem('token', data.token);
      
      // Decode token untuk tahu tujuannya
      const payloadToken = JSON.parse(atob(data.token.split('.')[1]));
      
      if (payloadToken.role === 'admin') {
        window.location.href = 'admin.html';
      } else {
        window.location.href = 'dashboard.html';
      }
    } else {
      // Jika error karena API Key kosong (untuk user biasa)
      alert(data.message);
    }
  } catch (err) {
    alert('Gagal terhubung ke server');
  }
}
</script>
</body>
</html>