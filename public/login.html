<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login | Web Service Wilayah</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="login.css">
</head>
<body>

<div class="card login-card">
  <div class="login-header">
    <i class="bi bi-geo-alt-fill icon-main"></i>
    <h4 class="mt-2 mb-0">Portal Wilayah</h4>
  </div>

  <div class="card-body p-4">
    <div class="mb-3">
      <label class="form-label small fw-bold">Email</label>
      <input id="email" type="email" class="form-control" placeholder="nama@email.com">
    </div>

    <div class="mb-3">
      <label class="form-label small fw-bold">Password</label>
      <input id="password" type="password" class="form-control" placeholder="••••••••">
    </div>

    <div class="mb-4">
      <div class="d-flex justify-content-between">
        <label class="form-label small fw-bold text-primary">API Key</label>
        <a href="javascript:void(0)" onclick="revealApiKey()"
           class="small text-decoration-none text-danger fw-bold">
          Lupa API Key?
        </a>
      </div>
      <input id="apiKey" class="form-control" placeholder="Masukkan API Key anda">
    </div>

    <button class="btn btn-primary w-100 mb-3" onclick="login()">Masuk</button>

    <div class="text-center small">
      Belum punya akun?
      <a href="register.html" class="fw-bold text-decoration-none">Daftar</a>
    </div>
  </div>
</div>

<!-- MODAL API KEY -->
<div class="modal fade" id="revealModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content modal-rounded">
      <div class="modal-body text-center p-4">
        <i class="bi bi-key-fill text-warning modal-icon"></i>
        <h5 class="fw-bold mt-3">API Key Anda Ditemukan!</h5>
        <p class="text-muted small">
          Silakan salin kode di bawah ini untuk login:
        </p>

        <div class="api-key-box p-3 rounded mb-3">
          <code id="revealedKey" class="api-key-text"></code>
        </div>

        <button class="btn btn-outline-primary btn-sm mb-3" onclick="copyToClipboard()">
          <i class="bi bi-clipboard"></i> Copy API Key
        </button>

        <button type="button"
                class="btn btn-dark w-100 rounded-pill"
                data-bs-dismiss="modal">
          Tutup
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
async function revealApiKey() {
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;

  if (!email || !password) {
    alert('Isi email dan password dulu untuk melihat API Key');
    return;
  }

  try {
    const res = await fetch('/api/auth/reveal-api-key', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });

    const data = await res.json();
    if (res.ok) {
      document.getElementById('revealedKey').innerText = data.apiKey;
      const modal = new bootstrap.Modal(document.getElementById('revealModal'));
      modal.show();
    } else {
      alert(data.message);
    }
  } catch {
    alert('Terjadi kesalahan koneksi');
  }
}

function copyToClipboard() {
  const keyText = document.getElementById('revealedKey').innerText;
  navigator.clipboard.writeText(keyText).then(() => {
    alert('API Key berhasil disalin!');
    document.getElementById('apiKey').value = keyText;
  });
}

async function login() {
  const emailVal = email.value;
  const passwordVal = password.value;
  const apiKeyVal = apiKey.value;

  if (!emailVal || !passwordVal) {
    alert('Email dan Password wajib diisi!');
    return;
  }

  try {
    const res = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: emailVal,
        password: passwordVal,
        apiKey: apiKeyVal
      })
    });

    const data = await res.json();

    if (res.ok) {
      localStorage.setItem('token', data.token);
      const payload = JSON.parse(atob(data.token.split('.')[1]));
      window.location.href =
        payload.role === 'admin' ? 'admin.html' : 'dashboard.html';
    } else {
      alert(data.message);
    }
  } catch {
    alert('Gagal terhubung ke server');
  }
}
</script>

</body>
</html>
